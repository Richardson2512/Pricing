name: Keep Render Service Alive

# Run every 10 minutes to prevent Render free tier from sleeping
on:
  schedule:
    # Runs every 10 minutes
    - cron: '*/10 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  ping-render:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Render Scraper Service
        run: |
          echo "üîÑ Pinging Render service at $(date)"
          
          RENDER_URL="${{ secrets.RENDER_SCRAPER_URL }}"
          
          if [ -z "$RENDER_URL" ]; then
            echo "‚ö†Ô∏è RENDER_SCRAPER_URL secret not set!"
            echo "üìù To fix this:"
            echo "   1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   2. Click: 'New repository secret'"
            echo "   3. Name: RENDER_SCRAPER_URL"
            echo "   4. Value: https://pricing-s1on.onrender.com"
            echo "   5. Click: 'Add secret'"
            echo ""
            echo "‚è≠Ô∏è Skipping ping until secret is configured"
            exit 0
          fi
          
          echo "üì° Target: $RENDER_URL/health"
          
          # Ping with timeout
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 30 "$RENDER_URL/health" || echo "FAILED")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Ping successful (HTTP $HTTP_CODE)"
            echo "üìä Response: $BODY"
          elif [ "$RESPONSE" = "FAILED" ]; then
            echo "‚ö†Ô∏è Ping failed (connection error)"
            echo "üîç This might be normal if Render service is sleeping"
            echo "‚è≠Ô∏è Will retry in 10 minutes"
            exit 0
          else
            echo "‚ö†Ô∏è Ping returned HTTP $HTTP_CODE"
            echo "üìä Response: $BODY"
            echo "‚è≠Ô∏è Will retry in 10 minutes"
            exit 0
          fi
      
      - name: Log Success
        if: success()
        run: |
          echo "‚úÖ Render service is alive and responding"
          echo "‚è∞ Next ping in 10 minutes"
      
      - name: Log Failure
        if: failure()
        run: |
          echo "‚ùå Render service ping failed"
          echo "üîî Check Render dashboard for issues"

